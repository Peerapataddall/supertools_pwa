{% extends "base.html" %}
{% block title %}‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏° {{ c.number }}{% endblock %}

{% block head %}
<style>
  .cl-hero{
    background:
      radial-gradient(1200px 600px at -10% -20%, rgba(131,105,83,.25) 0%, rgba(131,105,83,0) 60%),
      linear-gradient(135deg, #f6f7fb 0%, #eef2ff 100%);
    border-bottom: 1px solid rgba(0,0,0,.06);
  }
  .cl-hero .title{ display:flex; align-items:center; gap:.65rem; font-weight:700; letter-spacing:.3px; }
  .cl-hero .title i{
    background:#fff; color:#836953; width:42px; height:42px; display:grid; place-items:center;
    border-radius:12px; box-shadow:0 6px 20px rgba(131,105,83,.18);
  }
  .glass{
    background: rgba(255,255,255,.85);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    border:1px solid rgba(0,0,0,.06); border-radius: 1rem; box-shadow: 0 10px 30px rgba(20,20,40,.06);
  }
  .btn-gradient{ background: linear-gradient(135deg, #7c5a3f 0%, #9b7b5f 60%, #c8a88e 100%); border: none; color:#fff; box-shadow: 0 8px 16px rgba(131,105,83,.25); }
  .btn-gradient:hover{ filter: brightness(.98); }
  .btn-ghost{ border:1px solid rgba(0,0,0,.12); }
  .table-modern thead th{
    background: linear-gradient(180deg, #fafbff 0%, #f2f4ff 100%);
    border-bottom:1px solid rgba(0,0,0,.06); color:#334155; font-weight:600;
  }
  .table-modern tbody tr{ transition: background-color .15s ease; }
  .table-modern tbody tr:hover{ background:#f9fafb; }
  .table-modern td, .table-modern th{ vertical-align: middle; }
  .badge-soft{ --bg:#e5e7eb; --fg:#111827; background:var(--bg); color:var(--fg); padding:.35rem .6rem; border-radius:999px; font-weight:700; }
  .badge-submitted{ --bg:#fff3cd; --fg:#7a5f1a; }
  .badge-approved{ --bg:#dcfce7; --fg:#166534; }
  .badge-replaced{ --bg:#e0e7ff; --fg:#3730a3; }
  .badge-closed{ --bg:#e5e7eb; --fg:#374151; }
</style>
{% endblock %}

{% block content %}

{% set STATUS_TH = {
  'SUBMITTED':'‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß',
  'APPROVED':'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
  'REPLACED':'‡∏™‡πà‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
  'REPLACEMENT':'‡∏™‡πà‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
  'CLOSED':'‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
  'DONE':'‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô'
} %}

<div class="cl-hero py-3 py-md-4">
  <div class="container">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-3">
        <div class="title fs-4">
          <i class="bi bi-clipboard2-pulse"></i>
          ‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏° {{ c.number }}
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-ghost" href="{{ url_for('claims_list') }}">
          <i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </a>

        {# ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° / ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° ===== #}
        {% if c.repair_job_id %}
          <a class="btn btn-outline-secondary" href="{{ url_for('repairs.view_', jid=c.repair_job_id) }}">
            <i class="bi bi-tools me-1"></i> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° #{{ c.repair_job_id }}
          </a>
        {% elif can('maintenance.create') or (current_user.is_admin or current_user.is_superuser) %}
          {% set _items = c.items|list %}
          {% if _items|length == 0 %}
            <button class="btn btn-secondary disabled" title="‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
              <i class="bi bi-wrench-adjustable me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏°
            </button>
          {% elif _items|length == 1 %}
            <form method="post"
                  action="{{ url_for('repairs.open_from_claim', cid=c.id, item_id=_items[0].id) }}"
                  class="d-inline">
              <button class="btn btn-primary">
                <i class="bi bi-wrench-adjustable me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏°
              </button>
            </form>
          {% else %}
            <div class="btn-group">
              <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-wrench-adjustable me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏°
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                {% for it in _items %}
                  <li>
                    <form method="post"
                          action="{{ url_for('repairs.open_from_claim', cid=c.id, item_id=it.id) }}">
                      <button type="submit" class="dropdown-item">
                        {{ it.sales_item.name }} ‚Äî ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {{ '%.2f'|format(it.qty_claim or 0) }}
                      </button>
                    </form>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        {% endif %}

        <a href="{{ url_for('claims_print', cid=c.id) }}" target="_blank" class="btn btn-gradient">
          <i class="bi bi-printer"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container my-3">
  <div class="row g-3">
    <div class="col-12">
      <div class="glass p-3 p-md-4">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="mb-1"><span class="text-secondary">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> {{ c.date.strftime('%d/%m/%Y') }}</div>
            <div class="mb-1"><span class="text-secondary">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span> {{ c.customer.name }}</div>
            <div class="mb-1">
              <span class="text-secondary">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏•‡∏°:</span>
              {% set s = (c.status or '')|upper %}
              {% if s == 'SUBMITTED' %}
                <span class="badge-soft badge-submitted">{{ STATUS_TH.get(s, s) }}</span>
              {% elif s == 'APPROVED' %}
                <span class="badge-soft badge-approved">{{ STATUS_TH.get(s, s) }}</span>
              {% elif s in ['REPLACED','REPLACEMENT'] %}
                <span class="badge-soft badge-replaced">{{ STATUS_TH.get(s, s) }}</span>
              {% elif s in ['CLOSED','DONE'] %}
                <span class="badge-soft badge-closed">{{ STATUS_TH.get(s, s) }}</span>
              {% else %}
                <span class="badge-soft">{{ STATUS_TH.get(s, s) }}</span>
              {% endif %}
            </div>
            <div class="mb-1"><span class="text-secondary">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</span> {{ c.quote.number }}</div>
            {% if c.remark %}
            <div class="mt-2"><span class="text-secondary">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> {{ c.remark }}</div>
            {% endif %}
          </div>

          {% if c.repair_job_id %}
          <div class="col-md-6">
            <div class="p-3 rounded border" style="background:#f8fafc">
              <div class="fw-semibold mb-1">
                <i class="bi bi-tools me-1"></i> ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏°‡∏ô‡∏µ‡πâ
              </div>
              <div class="mb-1">
                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°:
                <a href="{{ url_for('repairs.view_', jid=c.repair_job_id) }}" class="link-primary">
                  #{{ c.repair_job_id }}
                </a>
              </div>
              {% if c.repair_job %}
              <div class="small text-secondary">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: {{ c.repair_job.number }}</div>
              <div class="small text-secondary">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°: {{ c.repair_job.status_th or c.repair_job.status }}</div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="glass p-0">
        <div class="px-3 px-md-4 py-2 border-bottom" style="background:linear-gradient(180deg,#fafbff 0%,#f2f4ff 100%)">
          <span class="fw-semibold"><i class="bi bi-list-check me-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏•‡∏°</span>
        </div>
        <div class="table-responsive">
          <table class="table table-modern table-hover align-middle mb-0">
            <thead>
              <tr>
                <th style="width:60px" class="text-center">#</th>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th class="text-end" style="width:140px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏°</th>
                <th style="width:280px">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</th>
              </tr>
            </thead>
            <tbody>
              {% for it in c.items %}
              <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td><div class="fw-semibold">{{ it.sales_item.name }}</div></td>
                <td class="text-end">{{ '%.2f'|format(it.qty_claim or 0) }}</td>
                <td>
                  {% if it.replacement_equipment %}
                    <span class="badge bg-primary">{{ it.replacement_equipment.sku }}</span>
                    {{ it.replacement_equipment.name }}
                  {% else %}
                    <span class="text-muted">‚Äî ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô ‚Äî</span>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center text-muted py-5">
                  <div class="d-inline-flex flex-column align-items-center gap-2">
                    <div class="display-6">üßæ</div>
                    <div class="fw-semibold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    <div class="small">‡πÉ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏°‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
