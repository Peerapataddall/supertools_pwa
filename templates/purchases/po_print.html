<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>พิมพ์ใบสั่งซื้อ {{ po.number }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @page { size: A4; margin: 12mm; }
    html,body{ background:#fff; color:#000; font-family:"Prompt",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans Thai","Noto Sans",sans-serif; }
    body{ font-size:12.2px; }
    .doc{ width:100%; }

    .text-right{ text-align:right; }
    .small{ font-size:11px; }
    .muted{ color:#666; }
    .fw-600{ font-weight:600; }

    /* ---------- Header: Grid ---------- */
    .head{
      display:grid;
      grid-template-columns: 80px 1fr auto;     /* กล่องโลโก้ใหญ่ขึ้น */
      align-items:start;
      column-gap:10px;
      row-gap:4px;
      margin-bottom:8px;
      padding-bottom:8px;
      border-bottom:2px solid #1da1f2;
      page-break-inside:avoid;
    }

    /* โลโก้ "เต็มกล่อง" ด้วย background-image (ครอบคลุม JPG/PNG/SVG) */
    .logo-box{
      width:80px; height:80px;
      border:2px solid #1da1f2; border-radius:14px; overflow:hidden; background:#fff;
      display:flex; align-items:center; justify-content:center;
    }
    .logo-img{
      width:100%; height:100%;
      background-repeat:no-repeat;
      background-position:center;
      background-size:cover;          /* ครอบเต็มกรอบเสมอ */
    }

    .comp-name{ font-size:15px; font-weight:700; line-height:1.15; margin:0 0 2px 0; }
    .comp-lines .line{ line-height:1.25; }

    .head-right{ min-width:260px; }
    .doc-title{ font-size:18px; font-weight:700; line-height:1.2; margin:0 0 4px 0; }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px;
      border:1px solid #d0e7ff; background:#eef7ff; color:#1a6eea; font-size:11px; margin-left:6px;
    }

    /* กล่อง / ตาราง / รวมเงิน */
    .box{ border:1px solid #e6e9ef; border-radius:10px; padding:10px 12px; margin:10px 0 12px; page-break-inside:avoid; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background:#f6f8fc; border-top:1px solid #dfe6f4; border-bottom:1px solid #dfe6f4; padding:8px 8px; font-weight:600; }
    tbody td{ padding:7px 8px; border-bottom:1px solid #eef1f7; vertical-align:top; }
    tbody tr:last-child td{ border-bottom:1px solid #dfe6f4; }
    tbody tr{ page-break-inside:avoid; }
    .sku{ width:12% } .name{ width:44% } .qty{ width:10% } .unit{ width:10% } .price{ width:12% } .disc{ width:10% } .sum{ width:12% }

    .totals{ margin-top:10px; display:flex; gap:14px; }
    .totals .spacer{ flex:1; }
    .totals .panel{ width:320px; border:1px solid #e6e9ef; border-radius:10px; padding:10px 12px; page-break-inside:avoid; }
    .row-sum{ display:flex; justify-content:space-between; margin:6px 0; }
    .row-sum.total{ font-weight:700; border-top:1px dashed #ccd6ea; padding-top:8px; margin-top:8px; }

    .sign{ margin-top:26px; display:flex; gap:18px; page-break-inside:avoid; }
    .sign .cell{ flex:1; text-align:center; }
    .sig-line{ margin-top:36px; border-top:1px dashed #b5c2db; padding-top:6px; }

    .toolbar{ position:fixed; top:10px; right:10px; display:flex; gap:8px; }
    .tbtn{ border:1px solid #cfe0ff; background:#eaf2ff; color:#195fe0; padding:6px 10px; font-size:12px; border-radius:8px; cursor:pointer; }

    @media print{ .toolbar{ display:none !important; } body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; } }
  </style>
</head>
<body>
  <!-- Toolbar -->
  <div class="toolbar">
    <button class="tbtn" onclick="window.print()">พิมพ์</button>
    <button class="tbtn" onclick="window.close()">ปิด</button>
  </div>

  {# ===== Data binding ===== #}
  {% set c = company %}
  {% if c and c.logo_path %}
    {% set logo_url = url_for('static', filename=c.logo_path) %}
  {% else %}
    {# โลโก้ default ที่อยู่ใน static/images/logo-supertool.png #}
    {% set logo_url = url_for('static', filename='images/logo-supertool.png') %}
  {% endif %}
  {% set addr_parts = [ c and c.address or '', c and c.district or '', c and c.amphoe or '', c and c.province or '', c and c.postcode or '' ] %}
  {% set addr_join = addr_parts|select|join(' ') %}
  {% set STATUS_TH = {'DRAFT':'ฉบับร่าง', 'APPROVED':'อนุมัติ', 'ORDERED':'สั่งซื้อแล้ว'} %}
  {% set st_th = STATUS_TH.get((po.status or '')|upper, po.status or '-') %}

  <div class="doc">
    <!-- HEADER -->
    <div class="head">
      <div class="logo-box">
        <div class="logo-img" style="background-image:url('{{ logo_url }}');"></div>
      </div>

      <div class="comp">
        <div class="comp-name">{{ (c and c.name) or 'ชื่อบริษัทของคุณ' }}</div>
        <div class="comp-lines small muted">
          <div class="line">{{ addr_join or 'ที่อยู่บริษัท' }}</div>
          <div class="line">เลขผู้เสียภาษี: {{ (c and c.tax_id) or '-' }}</div>
          <div class="line">โทร: {{ (c and c.phone) or '-' }}</div>
        </div>
      </div>

      <div class="head-right">
        <div class="doc-title">
          ใบสั่งซื้อ (Purchase Order)
          <span class="chip">สถานะ: {{ st_th }}</span>
        </div>
        <div class="small muted">เลขที่เอกสาร: <span class="fw-600">{{ po.number }}</span></div>
        <div class="small muted">วันที่: {{ po.po_date|strftime('%d/%m/%Y') or '-' }}</div>
      </div>
    </div>

    <!-- INFO -->
    <div class="box">
      <div style="display:flex; gap:14px;">
        <div style="flex:1;">
          <div class="fw-600">ผู้ขาย (Supplier)</div>
          <div>{{ po.supplier.name if po.supplier else '-' }}</div>
          {% if po.supplier and po.supplier.tax_id %}<div class="small muted">เลขผู้เสียภาษี: {{ po.supplier.tax_id }}</div>{% endif %}
          {% if po.supplier and po.supplier.address %}<div class="small muted">ที่อยู่: {{ po.supplier.address }}</div>{% endif %}
        </div>
        <div style="flex:1;">
          <div class="fw-600">อ้างอิง</div>
          <div class="small muted">สร้างเมื่อ: {{ po.po_date|strftime('%d/%m/%Y') or '-' }}</div>
          <div class="small muted">พิมพ์เมื่อ: {{ (today or po.po_date)|strftime('%d/%m/%Y') }}</div>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <table>
      <thead>
        <tr>
          <th class="sku">SKU</th>
          <th class="name">ชื่อรายการ</th>
          <th class="qty text-right">จำนวน</th>
          <th class="unit">หน่วย</th>
          <th class="price text-right">ราคาต่อหน่วย</th>
          <th class="disc text-right">ส่วนลด (%)</th>
          <th class="sum text-right">รวม</th>
        </tr>
      </thead>
      <tbody>
        {% for it in po.items %}
        <tr>
          <td class="sku">{{ it.sku or '-' }}</td>
          <td class="name">{{ it.name }}</td>
          <td class="qty text-right">{{ '{:,.2f}'.format(it.qty or 0) }}</td>
          <td class="unit">{{ it.unit or '' }}</td>
          <td class="price text-right">{{ '{:,.2f}'.format(it.unit_cost or 0) }}</td>
          <td class="disc text-right">{{ '{:,.2f}'.format(it.discount_pct or 0) }}</td>
          <td class="sum text-right">{{ '{:,.2f}'.format(it.line_total or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- TOTALS -->
    {% set base = (po.amount_total or 0.0) %}
    {% set vat_rate = 0.07 %}
    {% set vat = base * vat_rate %}
    {% set grand = base + vat %}
    <div class="totals">
      <div class="spacer"></div>
      <div class="panel">
        <div class="row-sum">
          <div>มูลค่าก่อนส่วนลด</div>
          <div class="text-right">{{ '{:,.2f}'.format(po.amount_subtotal or 0) }}</div>
        </div>
        <div class="row-sum">
          <div>ส่วนลดรวม</div>
          <div class="text-right">{{ '{:,.2f}'.format(po.amount_discount or 0) }}</div>
        </div>
        <div class="row-sum">
          <div>ฐานภาษี (หลังหักส่วนลด)</div>
          <div class="text-right">{{ '{:,.2f}'.format(base) }}</div>
        </div>
        <div class="row-sum">
          <div>ภาษีมูลค่าเพิ่ม 7%</div>
          <div class="text-right">{{ '{:,.2f}'.format(vat) }}</div>
        </div>
        <div class="row-sum total">
          <div>รวมทั้งสิ้น</div>
          <div class="text-right">{{ '{:,.2f}'.format(grand) }}</div>
        </div>
        <div class="small muted">* คิด VAT จากฐานภาษี (ราคายังไม่รวม VAT)</div>
      </div>
    </div>

    <!-- SIGNATURES -->
    <div class="sign">
      <div class="cell">
        <div class="sig-line">ผู้อนุมัติ</div>
        <div class="small muted">วันที่........../........../..........</div>
      </div>
      <div class="cell">
        <div class="sig-line">ผู้จัดทำ</div>
        <div class="small muted">วันที่........../........../..........</div>
      </div>
      <div class="cell">
        <div class="sig-line">ผู้รับสินค้า</div>
        <div class="small muted">วันที่........../........../..........</div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('load', () => {
      setTimeout(() => window.print(), 200);
    });
  </script>
</body>
</html>
